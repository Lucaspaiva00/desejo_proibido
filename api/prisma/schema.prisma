generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum TermoTipo {
  TERMOS_USO
  POLITICA_PRIVACIDADE
}

enum AceiteOrigem {
  WEB
  MOBILE
}

enum DenunciaStatus {
  ABERTA
  EM_ANALISE
  RESOLVIDA
  IGNORADA
}

enum MensagemTipo {
  TEXTO
  PRESENTE
  SISTEMA
}

model Usuario {
  id           String            @id @default(cuid())
  email        String            @unique
  senhaHash    String
  ativo        Boolean           @default(true)
  isInvisivel  Boolean           @default(false)
  preferencias PreferenciaBusca?
  // ✅ Controle de permissões (Admin/moderação)
  role         Role              @default(USER)

  // ✅ Freemium / Premium
  plano     String  @default("FREE") // FREE | PREMIUM
  isPremium Boolean @default(false)

  // ✅ Modo invisível (Premium)
  modoInvisivel Boolean @default(false)

  // ✅ Boost de perfil (destaque temporário)
  boostAte DateTime?

  // ✅ Minutos disponíveis (para ligações / presentes / Woo)
  minutosDisponiveis Int @default(0)

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  perfil Perfil?
  fotos  Foto[]

  // Curtidas
  curtidasEnviadas  Curtida[] @relation("CurtidasEnviadas")
  curtidasRecebidas Curtida[] @relation("CurtidasRecebidas")

  // Matches
  matchesA  Match[]    @relation("MatchesA")
  matchesB  Match[]    @relation("MatchesB")
  mensagems Mensagem[]

  // Skips
  skipsEnviados  Skip[] @relation("SkipsEnviados")
  skipsRecebidos Skip[] @relation("SkipsRecebidos")

  // Bloqueios
  bloqueiosEnviados  Bloqueio[] @relation("BloqueiosEnviados")
  bloqueiosRecebidos Bloqueio[] @relation("BloqueiosRecebidos")

  // Denúncias
  denunciasFeitas    Denuncia[] @relation("DenunciasFeitas")
  denunciasRecebidas Denuncia[] @relation("DenunciasRecebidas")

  // ✅ Aceites legais
  aceitesTermos AceiteTermos[]

  // ✅ Admin actions / banimento global
  acoesAdminFeitas AcaoAdmin[] @relation("AcoesAdminFeitas")
  acoesAdminAlvo   AcaoAdmin[] @relation("AcoesAdminAlvo")
  banGlobal        BanGlobal?

  pagamentos Pagamento[]

  // ✅ Logs
  logsAcesso LogAcesso[]

  // ✅ Logs de denúncia (3 relações diferentes)
  logDenunciasComoDenunciante LogDenuncia[] @relation("LogDenunciaDenunciante")
  logDenunciasComoDenunciado  LogDenuncia[] @relation("LogDenunciaDenunciado")
  logDenunciasComoAdmin       LogDenuncia[] @relation("LogDenunciaAdmin")

  // ✅ Minutos e compras no Woo
  creditosMinutos CreditoMinuto[]
  comprasWoo      CompraWoo[]

  // ✅ Ligações (evita ambiguidade com @relation)
  ligacoesIniciadas SessaoLigacao[] @relation("LigacaoIniciada")
  ligacoesRecebidas SessaoLigacao[] @relation("LigacaoRecebida")

  // ✅ Presentes enviados/recebidos
  presentesEnviados  PresenteEnviado[] @relation("PresenteDe")
  presentesRecebidos PresenteEnviado[] @relation("PresentePara")

  @@index([ativo])
  @@index([role])
  @@index([isPremium])
  @@index([boostAte])
}

model Perfil {
  id           String    @id @default(cuid())
  usuarioId    String    @unique
  nome         String
  bio          String?   @db.Text
  cidade       String?
  estado       String?
  criadoEm     DateTime  @default(now())
  atualizadoEm DateTime  @updatedAt
  genero       String? // M | F | OUTRO (ou livre)
  nascimento   DateTime? // pra calcular idade
  verificado   Boolean   @default(false)
  usuario      Usuario   @relation(fields: [usuarioId], references: [id])

  @@index([cidade])
  @@index([estado])
}

model Foto {
  id        String   @id @default(cuid())
  usuarioId String
  url       String
  principal Boolean  @default(false)
  criadoEm  DateTime @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId])
  @@index([principal])
}

model Curtida {
  id            String   @id @default(cuid())
  deUsuarioId   String
  paraUsuarioId String
  criadoEm      DateTime @default(now())

  deUsuario   Usuario @relation("CurtidasEnviadas", fields: [deUsuarioId], references: [id])
  paraUsuario Usuario @relation("CurtidasRecebidas", fields: [paraUsuarioId], references: [id])

  @@unique([deUsuarioId, paraUsuarioId])
  @@index([paraUsuarioId])
  @@index([deUsuarioId, criadoEm])
}

model Match {
  id         String   @id @default(cuid())
  usuarioAId String
  usuarioBId String
  criadoEm   DateTime @default(now())

  usuarioA Usuario   @relation("MatchesA", fields: [usuarioAId], references: [id])
  usuarioB Usuario   @relation("MatchesB", fields: [usuarioBId], references: [id])
  conversa Conversa?

  @@unique([usuarioAId, usuarioBId])
  @@index([usuarioAId])
  @@index([usuarioBId])
}

model Conversa {
  id           String   @id @default(cuid())
  matchId      String   @unique
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  match            Match             @relation(fields: [matchId], references: [id])
  mensagens        Mensagem[]
  presenteEnviados PresenteEnviado[]
}

model Mensagem {
  id         String       @id @default(cuid())
  conversaId String
  autorId    String
  tipo       MensagemTipo @default(TEXTO)
  texto      String?      @db.Text
  metaJson   Json?
  criadoEm   DateTime     @default(now())

  conversa Conversa @relation(fields: [conversaId], references: [id])
  autor    Usuario  @relation(fields: [autorId], references: [id])

  @@index([conversaId])
  @@index([autorId])
  @@index([conversaId, criadoEm])
}

model Skip {
  id            String   @id @default(cuid())
  deUsuarioId   String
  paraUsuarioId String
  criadoEm      DateTime @default(now())

  deUsuario   Usuario @relation("SkipsEnviados", fields: [deUsuarioId], references: [id])
  paraUsuario Usuario @relation("SkipsRecebidos", fields: [paraUsuarioId], references: [id])

  @@unique([deUsuarioId, paraUsuarioId])
  @@index([paraUsuarioId])
  @@index([deUsuarioId, criadoEm])
}

model Bloqueio {
  id            String   @id @default(cuid())
  deUsuarioId   String
  paraUsuarioId String
  criadoEm      DateTime @default(now())

  deUsuario   Usuario @relation("BloqueiosEnviados", fields: [deUsuarioId], references: [id])
  paraUsuario Usuario @relation("BloqueiosRecebidos", fields: [paraUsuarioId], references: [id])

  @@unique([deUsuarioId, paraUsuarioId])
  @@index([paraUsuarioId])
  @@index([deUsuarioId])
}

model Denuncia {
  id            String         @id @default(cuid())
  denuncianteId String
  denunciadoId  String
  motivo        String
  descricao     String?        @db.Text
  status        DenunciaStatus @default(ABERTA)
  criadoEm      DateTime       @default(now())
  atualizadoEm  DateTime       @updatedAt

  denunciante  Usuario       @relation("DenunciasFeitas", fields: [denuncianteId], references: [id])
  denunciado   Usuario       @relation("DenunciasRecebidas", fields: [denunciadoId], references: [id])
  logDenuncias LogDenuncia[]

  @@index([denunciadoId])
  @@index([denuncianteId])
  @@index([status])
  @@index([criadoEm])
}

model Termo {
  id       String    @id @default(cuid())
  tipo     TermoTipo
  versao   String
  conteudo String    @db.LongText
  ativo    Boolean   @default(true)
  criadoEm DateTime  @default(now())

  aceites AceiteTermos[]

  @@unique([tipo, versao])
  @@index([tipo, ativo])
}

model AceiteTermos {
  id        String       @id @default(cuid())
  usuarioId String
  termoId   String
  origem    AceiteOrigem @default(WEB)
  ip        String?
  userAgent String?
  aceitoEm  DateTime     @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id])
  termo   Termo   @relation(fields: [termoId], references: [id])

  @@unique([usuarioId, termoId])
  @@index([usuarioId, aceitoEm])
  @@index([termoId])
}

model AcaoAdmin {
  id       String   @id @default(cuid())
  adminId  String
  alvoId   String?
  tipo     String
  motivo   String?  @db.Text
  detalhes String?  @db.Text
  criadoEm DateTime @default(now())

  admin Usuario  @relation("AcoesAdminFeitas", fields: [adminId], references: [id])
  alvo  Usuario? @relation("AcoesAdminAlvo", fields: [alvoId], references: [id])

  @@index([adminId, criadoEm])
  @@index([alvoId, criadoEm])
  @@index([tipo])
}

model BanGlobal {
  id        String    @id @default(cuid())
  usuarioId String    @unique
  motivo    String?   @db.Text
  ate       DateTime?
  ativo     Boolean   @default(true)
  criadoEm  DateTime  @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id])

  @@index([ativo])
  @@index([ate])
}

model Pagamento {
  id            String   @id @default(cuid())
  usuarioId     String
  mpPaymentId   String?  @unique
  mpOrderId     String?
  status        String
  plano         String
  valorCentavos Int
  moeda         String   @default("BRL")

  // ✅ novos (opcionais)
  tipo          String?  // "MINUTOS" | "PREMIUM"
  pacoteId      String?  // "MIN_10" | "MIN_30" etc

  criadoEm      DateTime @default(now())
  atualizadoEm  DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId])
  @@index([status])
}


model LogAcesso {
  id        String   @id @default(cuid())
  usuarioId String?
  email     String?
  evento    String
  rota      String?
  metodo    String?
  status    Int?
  ip        String?
  userAgent String?
  detalhe   String?
  criadoEm  DateTime @default(now())

  usuario Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  @@index([usuarioId])
  @@index([evento])
  @@index([criadoEm])
}

model LogDenuncia {
  id            String  @id @default(cuid())
  denunciaId    String?
  denuncianteId String?
  denunciadoId  String?

  adminId      String?
  tipo         String
  statusAntes  String?
  statusDepois String?
  motivo       String?
  detalhes     String?

  ip        String?
  userAgent String?

  criadoEm DateTime @default(now())

  denuncia    Denuncia? @relation(fields: [denunciaId], references: [id], onDelete: SetNull)
  denunciante Usuario?  @relation("LogDenunciaDenunciante", fields: [denuncianteId], references: [id], onDelete: SetNull)
  denunciado  Usuario?  @relation("LogDenunciaDenunciado", fields: [denunciadoId], references: [id], onDelete: SetNull)
  admin       Usuario?  @relation("LogDenunciaAdmin", fields: [adminId], references: [id], onDelete: SetNull)

  @@index([denunciaId])
  @@index([denunciadoId])
  @@index([tipo])
  @@index([criadoEm])
}

model CreditoMinuto {
  id        String   @id @default(cuid())
  usuarioId String
  tipo      String
  minutos   Int
  refTipo   String?
  refId     String?
  detalhes  String?
  criadoEm  DateTime @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([refTipo, refId])
  @@index([criadoEm])
}

model CompraWoo {
  id                String   @id @default(cuid())
  usuarioId         String
  orderId           String   @unique
  status            String
  produtoId         String?
  produtoNome       String?
  minutosCreditados Int
  payloadJson       Json?
  criadoEm          DateTime @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([criadoEm])
}

model SessaoLigacao {
  id String @id @default(cuid())

  usuarioId String
  usuario   Usuario @relation("LigacaoIniciada", fields: [usuarioId], references: [id], onDelete: Cascade)

  alvoId String
  alvo   Usuario @relation("LigacaoRecebida", fields: [alvoId], references: [id], onDelete: Cascade)

  status             String
  iniciadoEm         DateTime  @default(now())
  finalizadoEm       DateTime?
  segundosConsumidos Int       @default(0)
  minutosCobrados    Int       @default(0)

  @@index([usuarioId])
  @@index([alvoId])
  @@index([status])
}

model Presente {
  id        String   @id @default(cuid())
  nome      String
  minutos   Int      @default(0)
  imagemUrl String?
  ativo     Boolean  @default(true)
  criadoEm  DateTime @default(now())

  enviados PresenteEnviado[]

  @@index([ativo])
}

model PresenteEnviado {
  id            String   @id @default(cuid())
  presenteId    String
  conversaId    String
  deUsuarioId   String
  paraUsuarioId String
  minutos       Int
  criadoEm      DateTime @default(now())

  presente    Presente @relation(fields: [presenteId], references: [id], onDelete: Cascade)
  conversa    Conversa @relation(fields: [conversaId], references: [id], onDelete: Cascade)
  deUsuario   Usuario  @relation("PresenteDe", fields: [deUsuarioId], references: [id], onDelete: Cascade)
  paraUsuario Usuario  @relation("PresentePara", fields: [paraUsuarioId], references: [id], onDelete: Cascade)

  @@index([conversaId, criadoEm])
  @@index([paraUsuarioId, criadoEm])
  @@index([deUsuarioId, criadoEm])
}

model PreferenciaBusca {
  id        String @id @default(cuid())
  usuarioId String @unique

  // preferências básicas
  idadeMin Int? @default(18)
  idadeMax Int? @default(99)

  // filtros por localização
  cidade String?
  estado String?

  // filtros por "preferência"
  generoAlvo         String? // M | F | OUTRO | QUALQUER
  somenteVerificados Boolean @default(false)
  somenteComFoto     Boolean @default(false)

  // ordenação
  ordenarPor String @default("recent") // recent | boost

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([cidade])
  @@index([estado])
}
