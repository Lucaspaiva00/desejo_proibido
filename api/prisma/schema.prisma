generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum TermoTipo {
  TERMOS_USO
  POLITICA_PRIVACIDADE
}

enum AceiteOrigem {
  WEB
  MOBILE
}

enum DenunciaStatus {
  ABERTA
  EM_ANALISE
  RESOLVIDA
  IGNORADA
}

enum MensagemTipo {
  TEXTO
  PRESENTE
  SISTEMA
}

model Usuario {
  id           String            @id @default(cuid())
  email        String            @unique
  senhaHash    String
  ativo        Boolean           @default(true)
  isInvisivel  Boolean           @default(false)
  invisivelAte DateTime?
  preferencias PreferenciaBusca?
  idioma       String?           @default("pt") // ex: "pt", "en", "es"

  role Role @default(USER)

  plano     String  @default("FREE")
  isPremium Boolean @default(false)

  // ✅ NOVO: verificação de e-mail
  emailVerificado   Boolean   @default(false)
  emailVerificadoEm DateTime?

  modoInvisivel Boolean   @default(false)
  boostAte      DateTime?

  minutosDisponiveis Int @default(0)

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  perfil Perfil?
  fotos  Foto[]

  curtidasEnviadas  Curtida[] @relation("CurtidasEnviadas")
  curtidasRecebidas Curtida[] @relation("CurtidasRecebidas")

  matchesA  Match[]    @relation("MatchesA")
  matchesB  Match[]    @relation("MatchesB")
  mensagems Mensagem[]

  skipsEnviados  Skip[] @relation("SkipsEnviados")
  skipsRecebidos Skip[] @relation("SkipsRecebidos")

  bloqueiosEnviados  Bloqueio[] @relation("BloqueiosEnviados")
  bloqueiosRecebidos Bloqueio[] @relation("BloqueiosRecebidos")

  denunciasFeitas    Denuncia[] @relation("DenunciasFeitas")
  denunciasRecebidas Denuncia[] @relation("DenunciasRecebidas")

  aceitesTermos AceiteTermos[]

  acoesAdminFeitas AcaoAdmin[] @relation("AcoesAdminFeitas")
  acoesAdminAlvo   AcaoAdmin[] @relation("AcoesAdminAlvo")
  banGlobal        BanGlobal?

  pagamentos Pagamento[]

  logsAcesso LogAcesso[]

  logDenunciasComoDenunciante LogDenuncia[] @relation("LogDenunciaDenunciante")
  logDenunciasComoDenunciado  LogDenuncia[] @relation("LogDenunciaDenunciado")
  logDenunciasComoAdmin       LogDenuncia[] @relation("LogDenunciaAdmin")

  creditosMinutos CreditoMinuto[]
  comprasWoo      CompraWoo[]

  ligacoesIniciadas SessaoLigacao[] @relation("LigacaoIniciada")
  ligacoesRecebidas SessaoLigacao[] @relation("LigacaoRecebida")

  presentesEnviados  PresenteEnviado[] @relation("PresenteDe")
  presentesRecebidos PresenteEnviado[] @relation("PresentePara")

  lives       Live[]
  liveViewers LiveViewer[]

  wallet     Wallet?
  walletTxes WalletTx[]

  // ✅ NOVO: tokens (1:1 via models)
  emailToken EmailVerificacaoToken?
  resetTokens ResetSenhaToken[]

  @@index([ativo])
  @@index([role])
  @@index([isPremium])
  @@index([boostAte])
}

model EmailVerificacaoToken {
  id        String   @id @default(cuid())
  usuarioId String   @unique
  tokenHash String   @unique
  expiraEm  DateTime
  criadoEm  DateTime @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([expiraEm])
}

model ResetSenhaToken {
  id        String   @id @default(cuid())
  usuarioId String
  tokenHash String   @unique
  expiraEm  DateTime
  usadoEm   DateTime?
  criadoEm  DateTime @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([expiraEm])
  @@index([usadoEm])
}

model Perfil {
  id        String  @id @default(cuid())
  usuarioId String  @unique
  nome      String
  bio       String?
  cidade    String?
  estado    String?

  genero     String?
  nascimento DateTime?
  verificado Boolean   @default(false)

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([cidade])
  @@index([estado])
}

model Foto {
  id        String   @id @default(cuid())
  usuarioId String
  url       String
  principal Boolean  @default(false)
  criadoEm  DateTime @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([principal])
}

model Curtida {
  id            String   @id @default(cuid())
  deUsuarioId   String
  paraUsuarioId String
  criadoEm      DateTime @default(now())

  deUsuario   Usuario @relation("CurtidasEnviadas", fields: [deUsuarioId], references: [id], onDelete: Cascade)
  paraUsuario Usuario @relation("CurtidasRecebidas", fields: [paraUsuarioId], references: [id], onDelete: Cascade)

  @@unique([deUsuarioId, paraUsuarioId])
  @@index([paraUsuarioId])
  @@index([deUsuarioId, criadoEm])
}

model Match {
  id         String   @id @default(cuid())
  usuarioAId String
  usuarioBId String
  criadoEm   DateTime @default(now())

  usuarioA Usuario   @relation("MatchesA", fields: [usuarioAId], references: [id], onDelete: Cascade)
  usuarioB Usuario   @relation("MatchesB", fields: [usuarioBId], references: [id], onDelete: Cascade)
  conversa Conversa?

  @@unique([usuarioAId, usuarioBId])
  @@index([usuarioAId])
  @@index([usuarioBId])
}

model Conversa {
  id           String   @id @default(cuid())
  matchId      String   @unique
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  match            Match             @relation(fields: [matchId], references: [id], onDelete: Cascade)
  mensagens        Mensagem[]
  presenteEnviados PresenteEnviado[]
}

model Mensagem {
  id         String       @id @default(cuid())
  conversaId String
  autorId    String
  tipo       MensagemTipo @default(TEXTO)

  // ✅ texto original e idioma detectado
  texto          String?
  textoOriginal  String?
  idiomaOriginal String? @default("pt")

  metaJson Json?
  criadoEm DateTime @default(now())

  conversa Conversa @relation(fields: [conversaId], references: [id], onDelete: Cascade)
  autor    Usuario  @relation(fields: [autorId], references: [id], onDelete: Cascade)

  // ✅ cache de traduções
  traducoes MensagemTraducao[]

  @@index([conversaId])
  @@index([autorId])
  @@index([conversaId, criadoEm])
  @@index([idiomaOriginal])
}

model MensagemTraducao {
  id         String   @id @default(cuid())
  mensagemId String
  idioma     String // ex: "en", "pt", "es"
  texto      String
  criadoEm   DateTime @default(now())

  mensagem Mensagem @relation(fields: [mensagemId], references: [id], onDelete: Cascade)

  @@unique([mensagemId, idioma])
  @@index([idioma])
  @@index([mensagemId])
}

model Skip {
  id            String   @id @default(cuid())
  deUsuarioId   String
  paraUsuarioId String
  criadoEm      DateTime @default(now())

  deUsuario   Usuario @relation("SkipsEnviados", fields: [deUsuarioId], references: [id], onDelete: Cascade)
  paraUsuario Usuario @relation("SkipsRecebidos", fields: [paraUsuarioId], references: [id], onDelete: Cascade)

  @@unique([deUsuarioId, paraUsuarioId])
  @@index([paraUsuarioId])
  @@index([deUsuarioId, criadoEm])
}

model Bloqueio {
  id            String   @id @default(cuid())
  deUsuarioId   String
  paraUsuarioId String
  criadoEm      DateTime @default(now())

  deUsuario   Usuario @relation("BloqueiosEnviados", fields: [deUsuarioId], references: [id], onDelete: Cascade)
  paraUsuario Usuario @relation("BloqueiosRecebidos", fields: [paraUsuarioId], references: [id], onDelete: Cascade)

  @@unique([deUsuarioId, paraUsuarioId])
  @@index([paraUsuarioId])
  @@index([deUsuarioId])
}

model Denuncia {
  id            String         @id @default(cuid())
  denuncianteId String
  denunciadoId  String
  motivo        String
  descricao     String?
  status        DenunciaStatus @default(ABERTA)
  criadoEm      DateTime       @default(now())
  atualizadoEm  DateTime       @updatedAt

  denunciante  Usuario       @relation("DenunciasFeitas", fields: [denuncianteId], references: [id], onDelete: Cascade)
  denunciado   Usuario       @relation("DenunciasRecebidas", fields: [denunciadoId], references: [id], onDelete: Cascade)
  logDenuncias LogDenuncia[]

  @@index([denunciadoId])
  @@index([denuncianteId])
  @@index([status])
  @@index([criadoEm])
}

model Termo {
  id       String    @id @default(cuid())
  tipo     TermoTipo
  versao   String
  conteudo String
  ativo    Boolean   @default(true)
  criadoEm DateTime  @default(now())

  aceites AceiteTermos[]

  @@unique([tipo, versao])
  @@index([tipo, ativo])
}

model AceiteTermos {
  id        String       @id @default(cuid())
  usuarioId String
  termoId   String
  origem    AceiteOrigem @default(WEB)
  ip        String?
  userAgent String?
  aceitoEm  DateTime     @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  termo   Termo   @relation(fields: [termoId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, termoId])
  @@index([usuarioId, aceitoEm])
  @@index([termoId])
}

model AcaoAdmin {
  id       String   @id @default(cuid())
  adminId  String
  alvoId   String?
  tipo     String
  motivo   String?
  detalhes String?
  criadoEm DateTime @default(now())

  admin Usuario  @relation("AcoesAdminFeitas", fields: [adminId], references: [id], onDelete: Cascade)
  alvo  Usuario? @relation("AcoesAdminAlvo", fields: [alvoId], references: [id], onDelete: SetNull)

  @@index([adminId, criadoEm])
  @@index([alvoId, criadoEm])
  @@index([tipo])
}

model BanGlobal {
  id        String    @id @default(cuid())
  usuarioId String    @unique
  motivo    String?
  ate       DateTime?
  ativo     Boolean   @default(true)
  criadoEm  DateTime  @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([ativo])
  @@index([ate])
}

model Pagamento {
  id            String  @id @default(cuid())
  usuarioId     String
  mpPaymentId   String? @unique
  mpOrderId     String?
  status        String
  plano         String
  valorCentavos Int
  moeda         String  @default("BRL")

  tipo     String?
  pacoteId String?

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([status])
}

model LogAcesso {
  id        String   @id @default(cuid())
  usuarioId String?
  email     String?
  evento    String
  rota      String?
  metodo    String?
  status    Int?
  ip        String?
  userAgent String?
  detalhe   String?
  criadoEm  DateTime @default(now())

  usuario Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  @@index([usuarioId])
  @@index([evento])
  @@index([criadoEm])
}

model LogDenuncia {
  id            String  @id @default(cuid())
  denunciaId    String?
  denuncianteId String?
  denunciadoId  String?

  adminId      String?
  tipo         String
  statusAntes  String?
  statusDepois String?
  motivo       String?
  detalhes     String?

  ip        String?
  userAgent String?

  criadoEm DateTime @default(now())

  denuncia    Denuncia? @relation(fields: [denunciaId], references: [id], onDelete: SetNull)
  denunciante Usuario?  @relation("LogDenunciaDenunciante", fields: [denuncianteId], references: [id], onDelete: SetNull)
  denunciado  Usuario?  @relation("LogDenunciaDenunciado", fields: [denunciadoId], references: [id], onDelete: SetNull)
  admin       Usuario?  @relation("LogDenunciaAdmin", fields: [adminId], references: [id], onDelete: SetNull)

  @@index([denunciaId])
  @@index([denunciadoId])
  @@index([tipo])
  @@index([criadoEm])
}

model CreditoMinuto {
  id        String   @id @default(cuid())
  usuarioId String
  tipo      String
  minutos   Int
  refTipo   String?
  refId     String?
  detalhes  String?
  criadoEm  DateTime @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([refTipo, refId])
  @@index([criadoEm])
}

model CompraWoo {
  id                String   @id @default(cuid())
  usuarioId         String
  orderId           String   @unique
  status            String
  produtoId         String?
  produtoNome       String?
  minutosCreditados Int
  payloadJson       Json?
  criadoEm          DateTime @default(now())

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([criadoEm])
}

model SessaoLigacao {
  id String @id @default(cuid())

  usuarioId String
  usuario   Usuario @relation("LigacaoIniciada", fields: [usuarioId], references: [id], onDelete: Cascade)

  alvoId String
  alvo   Usuario @relation("LigacaoRecebida", fields: [alvoId], references: [id], onDelete: Cascade)

  tipo        String  @default("VIDEO")
  roomId      String?
  tokenCaller String?
  tokenCallee String?

  status             String
  iniciadoEm         DateTime  @default(now())
  aceitouEm          DateTime?
  finalizadoEm       DateTime?
  segundosConsumidos Int       @default(0)
  minutosCobrados    Int       @default(0)

  @@index([usuarioId])
  @@index([alvoId])
  @@index([status])
  @@index([tipo])
}

model Presente {
  id            String   @id @default(cuid())
  nome          String   @unique
  minutos       Int      @default(0)
  imagemUrl     String?
  custoCreditos Int      @default(0)
  ativo         Boolean  @default(true)
  criadoEm      DateTime @default(now())

  enviados PresenteEnviado[]

  @@index([ativo])
}

model PresenteEnviado {
  id            String   @id @default(cuid())
  presenteId    String
  conversaId    String
  deUsuarioId   String
  paraUsuarioId String
  minutos       Int
  custoCreditos Int      @default(0)
  criadoEm      DateTime @default(now())

  presente    Presente @relation(fields: [presenteId], references: [id], onDelete: Cascade)
  conversa    Conversa @relation(fields: [conversaId], references: [id], onDelete: Cascade)
  deUsuario   Usuario  @relation("PresenteDe", fields: [deUsuarioId], references: [id], onDelete: Cascade)
  paraUsuario Usuario  @relation("PresentePara", fields: [paraUsuarioId], references: [id], onDelete: Cascade)

  @@index([conversaId, criadoEm])
  @@index([paraUsuarioId, criadoEm])
  @@index([deUsuarioId, criadoEm])
}

model PreferenciaBusca {
  id        String @id @default(cuid())
  usuarioId String @unique

  idadeMin Int? @default(18)
  idadeMax Int? @default(99)

  cidade String?
  estado String?

  generoAlvo         String?
  somenteVerificados Boolean @default(false)
  somenteComFoto     Boolean @default(false)

  ordenarPor String @default("recent")

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([cidade])
  @@index([estado])
}

model Live {
  id          String    @id @default(cuid())
  hostId      String
  titulo      String?
  status      String    @default("ATIVA")
  criadaEm    DateTime  @default(now())
  encerradaEm DateTime?

  host        Usuario      @relation(fields: [hostId], references: [id], onDelete: Cascade)
  liveViewers LiveViewer[]

  @@index([hostId])
  @@index([status])
}

model LiveViewer {
  id              String    @id @default(cuid())
  liveId          String
  viewerId        String
  entrouEm        DateTime  @default(now())
  saiuEm          DateTime?
  minutosCobrados Int       @default(0)

  live   Live    @relation(fields: [liveId], references: [id], onDelete: Cascade)
  viewer Usuario @relation(fields: [viewerId], references: [id], onDelete: Cascade)

  @@unique([liveId, viewerId])
  @@index([liveId])
  @@index([viewerId])
}

model Wallet {
  userId        String   @id
  saldoCreditos Int      @default(0)
  updatedAt     DateTime @updatedAt

  user Usuario @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WalletTx {
  id       String   @id @default(cuid())
  userId   String
  tipo     String
  origem   String
  valor    Int
  refId    String?
  criadoEm DateTime @default(now())

  user Usuario @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, origem, refId])
  @@index([criadoEm])
}
